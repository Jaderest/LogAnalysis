# å¤§æ•°æ®è¯¾ç¨‹è®¾è®¡2â€”â€”LogAnalysis

## ç›®å½•
- [å¤§æ•°æ®è¯¾ç¨‹è®¾è®¡2â€”â€”LogAnalysis](#å¤§æ•°æ®è¯¾ç¨‹è®¾è®¡2loganalysis)
  - [ç›®å½•](#ç›®å½•)
  - [å°ç»„ä¿¡æ¯\&åˆ†å·¥æƒ…å†µ](#å°ç»„ä¿¡æ¯åˆ†å·¥æƒ…å†µ)
    - [å°ç»„ä¿¡æ¯](#å°ç»„ä¿¡æ¯)
    - [åˆ†å·¥æƒ…å†µ](#åˆ†å·¥æƒ…å†µ)
  - [è¯¦ç»†è®¾è®¡è¯´æ˜](#è¯¦ç»†è®¾è®¡è¯´æ˜)
    - [Task1](#task1)
      - [Mapperè®¾è®¡](#mapperè®¾è®¡)
      - [Reducerè®¾è®¡](#reducerè®¾è®¡)
      - [Partitionerè®¾è®¡](#partitionerè®¾è®¡)
      - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾)
    - [Task2](#task2)
      - [ä»£ç è®¾è®¡](#ä»£ç è®¾è®¡)
        - [æ¯å°æ—¶ç½‘ç«™æµè§ˆé‡](#æ¯å°æ—¶ç½‘ç«™æµè§ˆé‡)
        - [è®¿é—®ç½‘ç«™çš„ç”¨æˆ·ç«¯ç±»å‹](#è®¿é—®ç½‘ç«™çš„ç”¨æˆ·ç«¯ç±»å‹)
        - [æ•´åˆç»Ÿè®¡æ•°æ®](#æ•´åˆç»Ÿè®¡æ•°æ®)
        - [æ’åºå®ç°](#æ’åºå®ç°)
      - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾-1)
    - [Task3\_part1](#task3_part1)
      - [Mapperè®¾è®¡](#mapperè®¾è®¡-1)
      - [Reducerè®¾è®¡](#reducerè®¾è®¡-1)
      - [Partitionerè®¾è®¡](#partitionerè®¾è®¡-1)
      - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾-2)
    - [Task3\_part2](#task3_part2)
      - [Mapperè®¾è®¡](#mapperè®¾è®¡-2)
      - [Reducerè®¾è®¡](#reducerè®¾è®¡-2)
      - [Partitionerè®¾è®¡](#partitionerè®¾è®¡-2)
      - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾-3)
    - [Task3\_part3](#task3_part3)
      - [Mapperè®¾è®¡ï¼ˆBrowserTypeMapperï¼‰](#mapperè®¾è®¡browsertypemapper)
      - [Reducerè®¾è®¡ï¼ˆBrowserTypeReducerï¼‰](#reducerè®¾è®¡browsertypereducer)
      - [Partitionerè®¾è®¡](#partitionerè®¾è®¡-3)
      - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾-4)
      - [åˆ†æ](#åˆ†æ)
        - [ç»“æœåˆ†æï¼ˆTODOï¼‰](#ç»“æœåˆ†ætodo)
        - [](#)
    - [Task4\_part1](#task4_part1)
      - [Mapperè®¾è®¡ï¼ˆLogMapperï¼‰](#mapperè®¾è®¡logmapper)
      - [Reducerè®¾è®¡ï¼ˆLogReducerï¼‰](#reducerè®¾è®¡logreducer)
      - [Partitionerè®¾è®¡](#partitionerè®¾è®¡-4)
    - [Task4\_part2](#task4_part2)
      - [ç‰¹å¾é€‰å–ä¸ç”¨æˆ·è¡Œä¸ºå‘é‡è®¾è®¡](#ç‰¹å¾é€‰å–ä¸ç”¨æˆ·è¡Œä¸ºå‘é‡è®¾è®¡)
      - [K-Meansèšç±»ç®—æ³•èšç±»æµç¨‹](#k-meansèšç±»ç®—æ³•èšç±»æµç¨‹)
      - [Mapperè®¾è®¡](#mapperè®¾è®¡-3)
      - [Combinerè®¾è®¡ï¼ˆå’ŒReducerçš„æ ¸å¿ƒé€»è¾‘ä¸€è‡´ï¼‰](#combinerè®¾è®¡å’Œreducerçš„æ ¸å¿ƒé€»è¾‘ä¸€è‡´)
      - [èšç±»ç»“æœåˆ†æï¼ˆTODOï¼‰](#èšç±»ç»“æœåˆ†ætodo)

## å°ç»„ä¿¡æ¯&åˆ†å·¥æƒ…å†µ
é¡¹ç›®åœ°å€ï¼šhttps://github.com/Jaderest/LogAnalysis
### å°ç»„ä¿¡æ¯
- TODO ï¼ˆåˆ«ç›’æˆ‘ğŸ˜­ğŸ˜­ğŸ˜­ï¼‰


### åˆ†å·¥æƒ…å†µ
- TODO


## è¯¦ç»†è®¾è®¡è¯´æ˜
- æœ¬å®éªŒå››ä¸ªä»»åŠ¡å‡é‡‡ç”¨MapReduceæ¡†æ¶å®ç°ï¼Œç¯å¢ƒå¦‚ä¸‹
```
hadoop version: 3.2.1
openjdk version "1.8.0_452"
Apache Maven 3.6.3
```
- åŸºæœ¬æ¡†æ¶ä¸º
  - Mapper
  - Partitionerï¼ˆæ ¹æ®keyå°†Mapperåˆ†å‡ºçš„å†…å®¹ä¼ ç»™ä¸åŒçš„Reducerï¼Œç”±æ­¤æé«˜ä»£ç çš„å¯æ‰©å±•æ€§ï¼Œåœ¨æ›´å¤§çš„é›†ç¾¤ä¸Šä¹Ÿå…·æœ‰åŒæ ·çš„æ‰©å±•æ€§ï¼‰
  - Combinerï¼ˆå¯é€‰ï¼Œé€šå¸¸ç”¨äºå¯¹Mapperçš„è¾“å‡ºè¿›è¡Œå±€éƒ¨èšåˆï¼Œå‡å°‘ä¼ è¾“æ•°æ®é‡ï¼Œæ­¤å¤„ä»…ç”¨äºK-meansèšç±»ç®—æ³•ä¸­ï¼‰
  - Reducer
  - Driverï¼ˆè´Ÿè´£å°†Mapperå’ŒReducerè¿æ¥èµ·æ¥ï¼Œè®¾ç½®è¾“å…¥è¾“å‡ºè·¯å¾„ç­‰ï¼‰


### Task1

è§£æNginxæ—¥å¿—æ–‡ä»¶ï¼Œæå–å…³é”®å­—æ®µä¿¡æ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯IPåœ°å€è¿›è¡Œæ•°æ®åˆ†åŒºå¤„ç†ï¼Œä»¥æ­¤å®ç°æ—¥å¿—æ•°æ®çš„ç»“æ„åŒ–è¾“å‡º

è®¾è®¡æ€è·¯ï¼š
ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æå–åŒ…æ‹¬IPåœ°å€ã€è®¿é—®æ—¶é—´ã€è¯·æ±‚URLã€çŠ¶æ€ç ç­‰å…³é”®å­—æ®µï¼ŒåŒæ—¶æ ¹æ®IPåœ°å€çš„ç¬¬ä¸€ä¸ªå…«ä½å­—èŠ‚å®ç°æ•°æ®åˆ†åŒº

#### Mapperè®¾è®¡
- LogMapperç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`<LongWritable, Text>`ï¼Œ`LongWritable`ä¸ºè¡Œå·ï¼Œ`Text`ä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, Text>`ï¼Œåˆ†åˆ«ä¸ºIPåœ°å€å’Œæ ¼å¼åŒ–åçš„æ—¥å¿—ä¿¡æ¯
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    Matcher matcher = logPattern.matcher(value.toString());
    if (matcher.find()) {
        String remoteAddr = matcher.group(1);
        StringBuilder sb = new StringBuilder();
        //æŒ‰æ—¥å¿—å†…å®¹åˆ†ç±»
        sb.append("remote_addr:").append(remoteAddr).append("\n");
        sb.append("remote_user:").append(matcher.group(2)).append(" ").append(matcher.group(3)).append("\n");
        sb.append("time_local:").append(matcher.group(4)).append("\n");
        sb.append("request:").append(matcher.group(5)).append("\n");
        sb.append("status:").append(matcher.group(6)).append("\n");
        sb.append("body_bytes_sent:").append(matcher.group(7)).append("\n");
        sb.append("http_referer:\"").append(matcher.group(8)).append("\"\n");
        sb.append("http_user_agent:\"").append(matcher.group(9)).append("\"\n");

       context.write(new Text(remoteAddr), new Text(sb.toString()));
    }
    ```

#### Reducerè®¾è®¡
- LogReducerç±»
- è¾“å…¥é”®å€¼å¯¹ï¼š`<Text, Iterable<Text>>`ï¼Œ`Text`ä¸ºIPåœ°å€ï¼Œ`Iterable<Text>`ä¸ºå¯¹åº”çš„æ—¥å¿—ä¿¡æ¯é›†åˆ
- è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, NullWritable>`ï¼Œ`Text`ä¸ºæ ¼å¼åŒ–åçš„æ—¥å¿—ä¿¡æ¯
- ä»£ç å¦‚ä¸‹ï¼š
    ```java
    for (Text val : values) {
        context.write(val, NullWritable.get());
    }
    ```

#### Partitionerè®¾è®¡
- æ ¹æ®IPåœ°å€çš„ç¬¬ä¸€ä¸ªå…«ä½å­—èŠ‚åˆ†ç»„
- ä»£ç å¦‚ä¸‹ï¼š
    ```java
    try {
        String ip = key.toString();
        String firstOctetStr = ip.split("\\.")[0]; // å–ç¬¬ä¸€ä¸ªå­—æ®µ
        int firstOctet = Integer.parseInt(firstOctetStr);
        return (firstOctet < 127) ? 0 : 1;
    } catch (Exception e) {
        // å¦‚æœ>=127ï¼Œé»˜è®¤åˆ†åˆ° Reducer 1
        return 1;
    }
    ```

#### è¾“å‡ºç»“æœæˆªå›¾
- è¾“å‡ºä¸¤ä¸ªç»“æœæ–‡ä»¶å¯¹åº”ä¸åŒIPæ®µ
- æ¯ä¸ªæ–‡ä»¶åŒ…å«å®Œæ•´æ ¼å¼åŒ–çš„æ—¥å¿—ä¿¡æ¯
æ ·ä¾‹è¾“å‡ºç¤ºä¾‹å¦‚ä¸‹:
![task1_1](./issue/image-task1_1.png)  
å¹³å°å…¨éƒ¨æ•°æ®è¾“å‡ºç¤ºä¾‹å¦‚ä¸‹:  
![task1_1å¹³å°](./issue/image-task1_1å¹³å°.png)
- æ–‡ä»¶è·¯å¾„ï¼š`/user/gr58/final/output/task1`

### Task2

ç»Ÿè®¡æ¯å°æ—¶ç½‘ç«™æµè§ˆé‡å’Œè®¿é—®ç½‘ç«™çš„ç”¨æˆ·ç«¯ç±»å‹ï¼Œå®ç°ç»Ÿè®¡ç»“æœçš„æ’åºè¾“å‡º

è®¾è®¡æ€è·¯ï¼šä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹MapReduceä½œä¸šåˆ†åˆ«å¤„ç†æ¯å°æ—¶ç½‘ç«™æµè§ˆé‡ç»Ÿè®¡å’Œè®¿é—®ç½‘ç«™çš„ç”¨æˆ·ç«¯ç±»å‹ç»Ÿè®¡ï¼Œå†å®ç°äºŒæ¬¡æ’åºåŠŸèƒ½

#### ä»£ç è®¾è®¡

##### æ¯å°æ—¶ç½‘ç«™æµè§ˆé‡
- `HourMapper`ç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`<LongWritable, Text>`ï¼Œ`LongWritable`ä¸ºè¡Œå·ï¼Œ`Text`ä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, IntWritable>`ï¼Œè¾“å‡ºæ—¶é—´å’Œè®¡æ•°1
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    Matcher matcher = logPattern.matcher(value.toString());
    if (matcher.find()) {
        String hour = matcher.group(3) + matcher.group(2) + matcher.group(1) + matcher.group(4);
        context.write(new Text(hour), new IntWritable(1));
    }
    ```

##### è®¿é—®ç½‘ç«™çš„ç”¨æˆ·ç«¯ç±»å‹  
- `UserAgentMapper`ç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`<LongWritable, Text>`ï¼Œ`LongWritable`ä¸ºè¡Œå·ï¼Œ`Text`ä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, IntWritable>`ï¼Œè¾“å‡ºå®¢æˆ·ç«¯ç±»å‹å’Œè®¡æ•°1
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    Matcher matcher = userAgentPattern.matcher(value.toString());
    if (matcher.find()) {
        String userAgent = matcher.group(1);
        String type = classifyUserAgent(userAgent);//åˆ¤æ–­æ˜¯ä»€ä¹ˆç±»å‹çš„å®¢æˆ·ç«¯
        context.write(new Text(type), new IntWritable(1));
    }
    ```

##### æ•´åˆç»Ÿè®¡æ•°æ®
- `SumReducer`ç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`<Text, IntWritable>`ï¼Œ`Text`ä¸ºç»Ÿè®¡ç±»å‹ï¼Œ`IntWritable`ä¸ºç»Ÿè®¡æ¬¡æ•°1
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`<key, IntWritable>`ï¼Œ`Text`ä¸ºç»Ÿè®¡ç±»å‹ï¼ˆåŒè¾“å…¥é”®å€¼å¯¹ï¼‰ï¼Œ`IntWritable`ä¸ºè¯¥ç±»å‹æ€»å‡ºç°æ¬¡æ•°
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    int sum = 0;
    for (IntWritable val : values)
        sum += val.get();
    context.write(key, new IntWritable(sum));
    ```

##### æ’åºå®ç°
- `SwapMapperç±»`
  - äº¤æ¢é”®å€¼å¯¹ä¸º`<è®¡æ•°, ç±»å‹>`
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    String[] parts = value.toString().split("\t");
    if (parts.length == 2) {
        long count = Long.parseLong(parts[1]);
        context.write(new LongWritable(count), new Text(parts[0]));
    }
    ```
- `DescendingKeyComparator`ç±»
  - å®ç°é™åºæ¯”è¾ƒ
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    return -super.compare(a, b); // é™åºæ’åº
    ```
- `OutputReducer`ç±»
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    for (Text val : values) {
        context.write(val, key);
    }
    ```

#### è¾“å‡ºç»“æœæˆªå›¾
**æ¯å°æ—¶ç½‘ç«™æµè§ˆé‡ç»Ÿè®¡**

![task2_1](./issue/image-task2_1.png)  
å¹³å°æˆªå›¾å¦‚ä¸‹  
![task2_1](./issue/image-task2_1å¹³å°.png)

**è®¿é—®ç½‘ç«™çš„ç”¨æˆ·ç«¯ç±»å‹**

![task2_2](./issue/image-task2_2.png)  
å¹³å°æˆªå›¾å¦‚ä¸‹  
![task2_2å¹³å°](./issue/image-task2_2å¹³å°.png)


### Task3_part1
åˆ†æä¼ è¾“æ•°æ®é‡ä¸çŠ¶æ€ç çš„å…³ç³»ï¼šæ ¹æ®body_bytes_sentå­—æ®µå’Œstatuså­—æ®µï¼Œåˆ†æè¯·æ±‚å¤±è´¥ä¸å¤§æ–‡ä»¶ä¼ è¾“æ˜¯å¦ç›¸å…³ã€‚

è®¾è®¡æ€è·¯ï¼šæ ¹æ®çŠ¶æ€ç è¿›è¡ŒåŒºåˆ†ï¼Œç»Ÿè®¡æ¯ä¸ªçŠ¶æ€ç å¯¹åº”çš„body_bytes_sentå­—æ®µçš„å¹³å‡å€¼ï¼Œåˆ†æä¼ è¾“æ•°æ®é‡ä¸çŠ¶æ€ç çš„å…³ç³»ã€‚ä½¿ç”¨`ä¸¤ä¸ªReducer`å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªReducerå¤„ç†çŠ¶æ€ç ä¸º2xxçš„è¯·æ±‚ï¼ˆæˆåŠŸè¯·æ±‚ï¼‰ï¼Œå¦ä¸€ä¸ªReducerå¤„ç†çŠ¶æ€ç ä¸º4xxå’Œ5xxçš„è¯·æ±‚ï¼ˆå¤±è´¥è¯·æ±‚ï¼‰ã€‚

#### Mapperè®¾è®¡
- LogMapperç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`(LongWritable, Text)`ï¼Œå…¶ä¸­LongWritableä¸ºè¡Œå·ï¼ŒTextä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`(Text, FloatWritable)`ï¼Œå…¶ä¸­Textä¸ºçŠ¶æ€ç ï¼ŒFloatWritableä¸ºbody_bytes_sentå­—æ®µçš„å€¼
- ä»£ç å¦‚ä¸‹ï¼š
```java
Matcher matcher = logPattern.matcher(value.toString());
if (matcher.find()) {
    String status = matcher.group(6); // é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è·å–çŠ¶æ€ç 
    String bodyBytesSent = matcher.group(7); // è·å–body_bytes_sentå­—æ®µ
    float dataSent = Float.parseFloat(bodyBytesSent);
    context.write(new Text(status), new FloatWritable(dataSent));
}
```

#### Reducerè®¾è®¡
- LogReducerç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`<Text, Iterable<FloatWritable>>`ï¼Œå…¶ä¸­Textä¸ºçŠ¶æ€ç ï¼ŒIterable<FloatWritable>ä¸ºæ‰€æœ‰ç›¸åŒçŠ¶æ€ç çš„body_bytes_sentå€¼
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, FloatWritable>`ï¼Œå…¶ä¸­Textä¸ºçŠ¶æ€ç ï¼ŒFloatWritableä¸ºbody_bytes_sentçš„å¹³å‡å€¼
  - ä»£ç å¦‚ä¸‹ï¼š
    ```java
    float sum = 0;
    int count = 0;
    for (FloatWritable value : values) { // ç»Ÿè®¡åŒä¸€çŠ¶æ€ç çš„æ‰€æœ‰å‘é€æ•°é‡
        sum += value.get();
        count++;
    }
    float average = sum / count;
    context.write(key, new FloatWritable(average));
    ```

#### Partitionerè®¾è®¡
- æ ¹æ®çŠ¶æ€ç è¿›è¡Œåˆ†ç»„
- ä»£ç å¦‚ä¸‹ï¼š
  ```java
  if (status.equals("200") || status.equals("201") || status.equals("202") || status.equals("204")) {
    return 0;
  } else {
      return 1;
  }
  ```

#### è¾“å‡ºç»“æœæˆªå›¾
- è¾“å‡ºç»“æœä¸ºä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”çŠ¶æ€ç ä¸º2xxå’Œ4xx/5xxçš„è¯·æ±‚
- æˆåŠŸè¯·æ±‚ï¼ˆ2xxï¼‰è¾“å‡ºç¤ºä¾‹ï¼š

![alt text](./issue/image.png)
- å¤±è´¥è¯·æ±‚ï¼ˆ4xx/5xxï¼‰è¾“å‡ºç¤ºä¾‹ï¼š

![alt text](./issue/image-1.png)
- åˆ†æå¦‚ä¸‹ï¼š
  - è¯·æ±‚æˆåŠŸå¤±è´¥ä¸å¦å’Œä¼ è¾“æ•°æ®é‡å¹¶æ— å¤ªå¤§å…³ç³»
  - åªæœ‰ä¸€ä¸ª499çŠ¶æ€ç æ¯”è¾ƒå¯ç–‘ï¼Œ499çŠ¶æ€ç é€šå¸¸å‡ºç°åœ¨ Nginx æœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œè¡¨ç¤º å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­äº†è¯·æ±‚è¿æ¥
    - åŒæ—¶å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®é‡è¾ƒå¤§ï¼Œå¯èƒ½æ˜¯å› ä¸ºå®¢æˆ·ç«¯åœ¨ä¼ è¾“å¤§æ–‡ä»¶æ—¶è¶…æ—¶ï¼Œæˆ–æ˜¯æœåŠ¡å™¨ç”Ÿæˆå¤§å“åº”ï¼ˆå¦‚å¤æ‚æŸ¥è¯¢ã€æ–‡ä»¶ä¸‹è½½ï¼‰è€—æ—¶è¿‡é•¿ï¼Œå¯¼è‡´ç”¨æˆ·å¤±å»è€å¿ƒ

### Task3_part2
æœ¬ä»»åŠ¡ä»¥å°æ—¶ä¸ºç²’åº¦ç»Ÿè®¡é”™è¯¯è¯·æ±‚å æ¯”ï¼ˆå³é”™è¯¯ç‡ï¼‰ï¼Œé€šè¿‡æ’åºåˆ†æä¸åŒæ—¶é—´æ®µå†…çš„é”™è¯¯ç‡æ³¢åŠ¨æƒ…å†µ


#### Mapperè®¾è®¡
- è¾“å…¥é”®å€¼å¯¹ï¼š`<LongWritable, Text>`
- è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, IntWritable>` Textè¡¨ç¤ºæ—¶é—´æ®µï¼ŒIntWritableè¡¨ç¤ºæ˜¯å¦é”™è¯¯ï¼Œä¸æ˜¯é”™è¯¯åˆ™ä¸º0ï¼Œæ˜¯é”™è¯¯åˆ™ä¸º1
- ä»£ç å¦‚ä¸‹ï¼š
  ```java
  String status = matcher.group(6); // è¯·æ±‚çŠ¶æ€ç 
  String timeLocal = matcher.group(4); // è·å–è®¿é—®æ—¶é—´
  // å°†è®¿é—®æ—¶é—´è½¬æ¢ä¸ºå°æ—¶
  Date date = sdf.parse(timeLocal);
  String hour = new SimpleDateFormat("HH").format(date);

  // å¦‚æœè¯·æ±‚çŠ¶æ€æ˜¯å¤±è´¥ï¼ˆé200ç³»åˆ—ï¼‰ï¼Œåˆ™è®¤ä¸ºæ˜¯é”™è¯¯
  nt isError = (status.startsWith("2")) ? 0 : 1;

  // è¾“å‡ºæ—¶é—´æ®µï¼ˆå°æ—¶ï¼‰å’Œé”™è¯¯è®¡æ•°
  context.write(new Text(hour), new IntWritable(isError));
  ```

#### Reducerè®¾è®¡
- å¯¹ç›¸åŒå°æ—¶æ‰€æœ‰è®°å½•è¿›è¡Œèšåˆ
- è¾“å…¥é”®å€¼å¯¹ï¼š`Text, [IntWritable(isError)...]>`ï¼Œå…¶ä¸­Textä¸ºå°æ—¶ï¼ŒIntWritableä¸ºæ˜¯å¦ä¸ºé”™è¯¯
- è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, FloatWritable>`ï¼Œè¾“å‡ºå°æ—¶å’Œå¹³å‡é”™è¯¯ç‡
- ä»£ç å¦‚ä¸‹ï¼š
  ```java
  int totalRequests = 0;
  int failedRequests = 0;

  for (IntWritable value : values) {
      totalRequests++;
      if (value.get() == 1) {
          failedRequests++;
      }
  }

  float errorRate = totalRequests > 0 ? (float) failedRequests / totalRequests : 0.0f;
  context.write(key, new FloatWritable(errorRate));
  ```

#### Partitionerè®¾è®¡
LogPartitioner å°†å°æ—¶åˆ’åˆ†ä¸ºç™½å¤©ï¼ˆ08~22ï¼‰ä¸å¤œé—´ï¼ˆ00~07å’Œ23ï¼‰ä¸¤ç±»ï¼Œåˆ†åˆ«äº¤ç”±ä¸¤ä¸ªReducerå¤„ç†ï¼Œä»¥ä¾¿è§‚å¯Ÿæ˜¼å¤œä¹‹é—´é”™è¯¯ç‡çš„å·®å¼‚ã€‚
ä»£ç å¦‚ä¸‹ï¼š
```java
int hour = Integer.parseInt(key.toString());
// å°†å°æ—¶åˆ†ä¸ºä¸¤ç»„ï¼š8-22ç‚¹ å’Œ 0-7ç‚¹ã€23ç‚¹
if (hour >= 8 && hour <= 22) {
    return 0; // ç™½å¤©æ—¶é—´æ®µ
} else {
    return 1; // å¤œé—´æ—¶é—´æ®µ
}
```

#### è¾“å‡ºç»“æœæˆªå›¾
- æ—¶é—´ç»“æœ  
![alt text](./issue/image-2.png)  
![alt text](./issue/image-3.png)
- æ—¶é—´çƒ­åŠ›å›¾  
![alt text](./issue/image-task3_2.png)


### Task3_part3
æœ¬ä»»åŠ¡æ—¨åœ¨åŸºäºWebæ—¥å¿—æ•°æ®ï¼Œç»“åˆæµè§ˆå™¨ç±»å‹ï¼Œç»Ÿè®¡æ¯ç§æµè§ˆå™¨çš„è¯·æ±‚é”™è¯¯ç‡å’Œå¹³å‡ä¼ è¾“æ•°æ®é‡ï¼Œå¹¶å¯¹é”™è¯¯ç‡è¿›è¡Œé™åºæ’åºï¼Œè¯†åˆ«é£é™©è¾ƒé«˜çš„æµè§ˆå™¨ç±»å‹ï¼Œè¾…åŠ©ç«™ç‚¹è¿ç»´ä¸é˜²å¾¡ç­–ç•¥åˆ¶å®šã€‚

ä»»åŠ¡åˆ†ä¸ºä¸¤ä¸ªMapReduce Jobå¦‚ä¸‹ï¼š
1. ç»Ÿè®¡æµè§ˆå™¨çš„é”™è¯¯ç‡ä¸å¹³å‡ä¼ è¾“æ•°æ®é‡ï¼ˆæ ¸å¿ƒä»»åŠ¡ï¼Œä½¿ç”¨äº†3ä¸ªreducerï¼‰
2. é”™è¯¯ç‡æ’åºï¼šæŒ‰ç…§ä»»åŠ¡è¦æ±‚æ ¹æ®é”™è¯¯ç‡è¿›è¡Œé™åºæ’åº

#### Mapperè®¾è®¡ï¼ˆBrowserTypeMapperï¼‰
- è¾“å…¥ï¼š`<LongWritable, Text>`ï¼Œå…¶ä¸­LongWritableä¸ºè¡Œå·ï¼ŒTextä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
- è¾“å‡ºï¼š`<Text, Text>`ï¼Œkeyä¸ºæµè§ˆå™¨ç±»å‹ï¼Œå€¼ä¸º`çŠ¶æ€ç :å­—èŠ‚æ•°`
- ä»£ç å¦‚ä¸‹ï¼š
```java
browser = classifyUserAgent(matcher.group(9)); // æå–æµè§ˆå™¨ç±»å‹
status = matcher.group(6); // æå–çŠ¶æ€ç 
dataSent = matcher.group(7); // æå–ä¼ è¾“æ•°æ®é‡
// browserRankæ˜¯setupé˜¶æ®µæ„é€ çš„mapï¼Œè¯»å–ä»»åŠ¡2(2)çš„è¾“å‡ºï¼Œå°†ç”¨æˆ·äººæ•°æœ€é«˜çš„åç§æµè§ˆå™¨ç±»å‹å­˜å‚¨åœ¨browserRankä¸­
if (browserRank.containsKey(browser)) {
    // è¾“å‡ºé”®å€¼å¯¹: æµè§ˆå™¨ç±»å‹ -> çŠ¶æ€ç : é”™è¯¯/æˆåŠŸï¼Œæ•°æ®é‡
    context.write(new Text(browser), new Text(status + ":" + dataSent));
}
```

#### Reducerè®¾è®¡ï¼ˆBrowserTypeReducerï¼‰
- è¾“å…¥ï¼š`<Text, Iterable<Text>>`ï¼Œå…¶ä¸­Textä¸ºæµè§ˆå™¨ç±»å‹ï¼ŒIterable<Text>ä¸ºçŠ¶æ€ç å’Œä¼ è¾“æ•°æ®é‡çš„é›†åˆ
- è¾“å‡ºï¼š`<Text, Text>`ï¼Œkeyä¸ºæµè§ˆå™¨ç±»å‹ï¼Œå€¼ä¸º`ErrorRate:x.xx,AvgDataSent:y.yy`
- ä»£ç å¦‚ä¸‹ï¼š
```java
int totalRequests = 0;
int failedRequests = 0;
float totalDataSent = 0;
// è®¡ç®—æ¯ç§æµè§ˆå™¨ç±»å‹ä¸‹ä¸åŒçŠ¶æ€ç çš„é”™è¯¯ç‡ä¸å¹³å‡æ•°æ®ä¼ è¾“é‡
for (Text value : values) {
    String[] parts = value.toString().split(":");
    String status = parts[0];
    float dataSent = Float.parseFloat(parts[1]);
    totalRequests++;
    totalDataSent += dataSent;
    if (!status.startsWith("2")) { // é200ç³»åˆ—ä¸ºå¤±è´¥è¯·æ±‚
        failedRequests++;
    }
}
float errorRate = totalRequests > 0 ? (float) failedRequests / totalRequests : 0.0f;
float averageDataSent = totalRequests > 0 ? totalDataSent / totalRequests : 0.0f;
// è¾“å‡ºæµè§ˆå™¨ç±»å‹å’Œç›¸å…³çš„çŠ¶æ€ç ç»Ÿè®¡ä¿¡æ¯
context.write(key, new Text("ErrorRate: " + errorRate + ", AvgDataSent: " + averageDataSent));
```

#### Partitionerè®¾è®¡
- æ ¹æ®æµè§ˆå™¨åçš„å“ˆå¸Œå€¼åˆ†é…åˆ°ä¸åŒçš„Reducer

#### è¾“å‡ºç»“æœæˆªå›¾
- é”™è¯¯ç‡è¾“å‡º  
![alt text](./issue/image-task3_3_1.png)  
![alt text](./issue/image-task3_3_2.png)  
![alt text](./issue/image-task3_3_3.png)
- é™åºæ’åºç»“æœ  
TODO

#### åˆ†æ

##### ç»“æœåˆ†æï¼ˆTODOï¼‰
##### 

### Task4_part1
æœ¬éƒ¨åˆ†ä¸»è¦æ˜¯ä»æ—¥å¿—æ–‡ä»¶ä¸­æå–æ•°æ®ç”¨ä»¥ç»™part2é˜¶æ®µä½¿ç”¨K-Meansèšç±»ç®—æ³•è¿›è¡Œç”¨æˆ·åˆ†ç¾¤ï¼Œæ‰€ä»¥åœ¨è®¾è®¡çš„æ—¶å€™ä¸åŒäºæ‰‹å†Œï¼Œæˆ‘å°½å¯èƒ½å°†æ•°æ®ç»†åŒ–å¹¶æé«˜åŒºåˆ†åº¦

#### Mapperè®¾è®¡ï¼ˆLogMapperï¼‰
- è¾“å…¥ï¼š`<LongWritable, Text>`ï¼Œå…¶ä¸­LongWritableä¸ºè¡Œå·ï¼ŒTextä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
- è¾“å‡ºï¼š`<Text, Text>`ï¼Œkeyä¸ºç”¨æˆ·IDï¼Œvalue ä¸ºæ ¼å¼åŒ–çš„ç‰¹å¾ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¾å¤‡ç±»å‹ã€è®¿é—®æ—¶é—´æ®µã€è¯·æ±‚ç±»å‹ã€å‘é€å­—èŠ‚æ•°ç­‰
- ä»£ç å¦‚ä¸‹ï¼š
```java
// æå– IPã€æ—¶é—´æˆ³ã€User-Agent ç­‰å­—æ®µ
String remoteAddr = matcher.group(1);
String timeLocal = matcher.group(4);
String requestType = matcher.group(5);
String bytesSended = matcher.group(8);
String userAgent = matcher.group(10);

// åˆ¤æ–­è®¾å¤‡ç±»å‹ï¼ˆPCç«¯ä¸º1ï¼Œç§»åŠ¨ç«¯ä¸º0ï¼‰
String deviceType = userAgent.toLowerCase().contains("mobile") ? "0" : "1";

// åˆ¤æ–­è®¿é—®æ—¶é—´æ®µï¼ˆ6ç‚¹è‡³18ç‚¹ä¸ºç™½å¤©ï¼Œå…¶ä½™ä¸ºå¤œæ™šï¼‰
String timeOfDay = classifyTimeOfDay(timeLocal);

// æ„é€ è¾“å‡ºç‰¹å¾å‘é‡æ ¼å¼
StringBuilder featureVector = new StringBuilder();
featureVector.append("device:").append(deviceType).append("\t");
featureVector.append("timeOfDay:").append(timeOfDay).append("\t");
featureVector.append("requestType:").append(requestType).append("\t");
featureVector.append("bytesSent:").append(bytesSended);

// è¾“å‡ºï¼š<IPåœ°å€, ç‰¹å¾ä¿¡æ¯ + è¯·æ±‚æ¬¡æ•°è®¡æ•°1>
context.write(new Text(remoteAddr), new Text(featureVector.toString() + "\t1"));
```

#### Reducerè®¾è®¡ï¼ˆLogReducerï¼‰
- è¾“å…¥ï¼š`<Text, Iterable<Text>>`ï¼ŒæŒ‰IPèšåˆçš„ç‰¹å¾é›†åˆ
- è¾“å‡ºï¼š`<Text, Text>`ï¼Œkeyä¸ºIPåœ°å€ï¼Œvalueä¸ºèšåˆåçš„å®Œæ•´è¡Œä¸ºç‰¹å¾å‘é‡
- ä»£ç å¦‚ä¸‹ï¼š
```java
// è§£ææ—¥å¿—ç‰¹å¾å­—æ®µ
long totalRequestsDay = 0;
long totalBytesSentDay = 0;
long totalRequestsNight = 0;
long totalBytesSentNight = 0;
Map<String, Integer> requestTypeCount = new HashMap<>();
String deviceType = "";

// éå†æ—¥å¿—è®°å½•ï¼Œè¿›è¡Œåˆ†ç±»ç»Ÿè®¡
for (Text val : values) {
    String[] parts = val.toString().split("\t");
    if (deviceType.isEmpty()) {
        deviceType = parts[0].split(":")[1];
    }
    String timeOfDay = parts[1].split(":")[1];
    String requestType = parts[2].split(":")[1];
    long bytesSent = Long.parseLong(parts[3].split(":")[1]);

    requestTypeCount.put(requestType, requestTypeCount.getOrDefault(requestType, 0) + 1);

    if ("day".equals(timeOfDay)) {
        totalRequestsDay += 1;
        totalBytesSentDay += bytesSent;
    } else {
        totalRequestsNight += 1;
        totalBytesSentNight += bytesSent;
    }
}

// è®¡ç®—å¹³å‡å€¼
double avgBytesSentDay = totalRequestsDay > 0 ? (double) totalBytesSentDay / totalRequestsDay : 0;
double avgBytesSentNight = totalRequestsNight > 0 ? (double) totalBytesSentNight / totalRequestsNight : 0;
long totalRequests = totalRequestsDay + totalRequestsNight;
double totalAvgBytesSent = totalRequests > 0
    ? (totalRequestsDay * avgBytesSentDay + totalRequestsNight * avgBytesSentNight) / totalRequests
    : 0;

// æ„é€ è¯·æ±‚ç±»å‹å‘é‡ï¼Œä¾‹å¦‚ [GET:10, POST:3]
StringBuilder requestTypeString = new StringBuilder();
for (Map.Entry<String, Integer> entry : requestTypeCount.entrySet()) {
    if (requestTypeString.length() > 0) requestTypeString.append(", ");
    requestTypeString.append(entry.getKey()).append(":").append(entry.getValue());
}

// è¾“å‡ºå®Œæ•´çš„ç‰¹å¾å‘é‡
StringBuilder featureVector = new StringBuilder();
featureVector.append("deviceType:").append(deviceType).append("\t");
featureVector.append("requestTypes:[").append(requestTypeString).append("]\t");
featureVector.append("dayRequests:").append(totalRequestsDay).append("\t");
featureVector.append("dayAvgBytesSent:").append(avgBytesSentDay).append("\t");
featureVector.append("nightRequests:").append(totalRequestsNight).append("\t");
featureVector.append("nightAvgBytesSent:").append(avgBytesSentNight).append("\t");
featureVector.append("totalRequests:").append(totalRequests).append("\t");
featureVector.append("totalAvgBytesSent:").append(totalAvgBytesSent);

context.write(key, new Text(featureVector.toString()));
```

#### Partitionerè®¾è®¡
- æ ¹æ®IPåœ°å€é¦–å­—èŠ‚åˆ’åˆ†ï¼Œå°äº127çš„IPåˆ†åˆ°Reducer 0ï¼Œå¤§äºç­‰äº127çš„åˆ†åˆ°Reducer 1
- ä»£ç å¦‚ä¸‹ï¼š
```java
public int getPartition(Text key, Text value, int numPartitions) {
    try {
        String ip = key.toString();
        int firstOctet = Integer.parseInt(ip.split("\\.")[0]);
        return (firstOctet < 127) ? 0 : 1;
    } catch (Exception e) {
        return 1; // å¼‚å¸¸é»˜è®¤åˆ†åˆ° 1
    }
}
```

### Task4_part2
æœ¬éƒ¨åˆ†ä¸»è¦æ˜¯å¯¹Task4_part1çš„è¾“å‡ºç»“æœè¿›è¡ŒK-Meansèšç±»åˆ†æï¼Œä»è€ŒæŒ–æ˜ä¸åŒç¾¤ä½“ç”¨æˆ·çš„å…¸å‹è¡Œä¸ºç‰¹å¾ï¼Œä¾‹å¦‚ç§»åŠ¨ç«¯å¤œé—´é«˜é¢‘ç”¨æˆ·ã€ç™½å¤©å¤§æµé‡è®¿é—®ç”¨æˆ·ç­‰ï¼Œä¸ºä¸ªæ€§åŒ–æ¨èã€ç”¨æˆ·ç”»åƒç­‰åº”ç”¨æ„å»ºåŸºç¡€

#### ç‰¹å¾é€‰å–ä¸ç”¨æˆ·è¡Œä¸ºå‘é‡è®¾è®¡
- ç‰¹å¾é€‰å–
  - dayRequestsï¼šç™½å¤©è¯·æ±‚æ¬¡æ•°
  - dayAvgBytesSentï¼šç™½å¤©å¹³å‡ä¼ è¾“å­—èŠ‚æ•°
  - nightRequestsï¼šå¤œé—´è¯·æ±‚æ¬¡æ•°
  - nightAvgBytesSentï¼šå¤œé—´å¹³å‡ä¼ è¾“å­—èŠ‚æ•°
- æ¯ä¸ªç”¨æˆ·æœ€ç»ˆè¢«è¡¨ç¤ºä¸ºä¸€ä¸ªå››ç»´å‘é‡ï¼š
  `[dayRequests, dayAvgBytesSent, nightRequests, nightAvgBytesSent]`

#### K-Meansèšç±»ç®—æ³•èšç±»æµç¨‹
1. åˆå§‹ä¸­å¿ƒè®¾å®š
    åœ¨`Mapper`çš„`setup()`æ–¹æ³•ä¸­é¢„è®¾ä¸¤ä¸ªåˆå§‹èšç±»ä¸­å¿ƒï¼š
    - Cluster0:[10.0, 500.0, 8.0, 400.0]
    - Cluster1:[20.0, 1500.0, 30.0, 1300.0]
2. è·ç¦»è®¡ç®—ä¸åˆ†é…(Mapper)
    - å¯¹æ¯ä¸ªç”¨æˆ·è¡Œä¸ºå‘é‡ï¼Œè®¡ç®—å…¶ä¸å„ä¸ªä¸­å¿ƒçš„æ¬§å¼è·ç¦»ã€‚
    - å°†è¯¥ç”¨æˆ·åˆ†é…åˆ°æœ€è¿‘çš„èšç±»ä¸­å¿ƒã€‚
    - è¾“å‡ºæ ¼å¼ä¸ºï¼š
      ```
      <èšç±»ç¼–å·, IP, dayReq, dayAvg, nightReq, nightAvg, 1>
      ```
3. å±€éƒ¨èšåˆ(Combiner)
    - å¯¹æ¯ä¸ªèšç±»ç¼–å·çš„å¤šä¸ªç”¨æˆ·æ•°æ®ï¼Œè¿›è¡Œå±€éƒ¨åˆå¹¶ï¼Œè®¡ç®—åŠ æƒæ±‚å’Œä¸é¢‘æ•°
4. å…¨å±€èšåˆæ›´æ–°ä¸­å¿ƒ(Reducer)
    - æ¥æ”¶æ‰€æœ‰åŒä¸€èšç±»ç¼–å·çš„æ•°æ®ï¼Œé‡æ–°è®¡ç®—èšç±»ä¸­å¿ƒï¼ˆå³å››ä¸ªç»´åº¦çš„åŠ æƒå¹³å‡ï¼‰
5. è¿­ä»£æ‰§è¡Œ

#### Mapperè®¾è®¡
- æå–ç”¨æˆ·è¡Œä¸ºå‘é‡å¹¶åˆ†é…èšç±»
```java
double[] point = { dayRequests, dayAvgBytesSent, nightRequests, nightAvgBytesSent };
double distance = computeEuclideanDistance(point, center.getCenter());
```
- è¾“å‡ºæ ¼å¼
```java
context.write(new IntWritable(closestClusterId),
              new Text(ip + "," + dayRequests + "," + dayAvgBytesSent + "," +
                       nightRequests + "," + nightAvgBytesSent + ",1"));
```

#### Combinerè®¾è®¡ï¼ˆå’ŒReducerçš„æ ¸å¿ƒé€»è¾‘ä¸€è‡´ï¼‰
- è®¡ç®—æ‰€æœ‰ç‚¹çš„åŠ æƒå¹³å‡ï¼ˆä¸­å¿ƒæ›´æ–°ï¼‰
```java
sum[0] += dayReq * freq;
sum[1] += dayAvg * freq;
...
newCenter[i] = sum[i] / count;
```

#### èšç±»ç»“æœåˆ†æï¼ˆTODOï¼‰