# å¤§æ•°æ®è¯¾ç¨‹è®¾è®¡2â€”â€”LogAnalysis

## ç›®å½•
- [å¤§æ•°æ®è¯¾ç¨‹è®¾è®¡2â€”â€”LogAnalysis](#å¤§æ•°æ®è¯¾ç¨‹è®¾è®¡2loganalysis)
  - [ç›®å½•](#ç›®å½•)
  - [å°ç»„ä¿¡æ¯\&åˆ†å·¥æƒ…å†µ](#å°ç»„ä¿¡æ¯åˆ†å·¥æƒ…å†µ)
    - [å°ç»„ä¿¡æ¯](#å°ç»„ä¿¡æ¯)
    - [åˆ†å·¥æƒ…å†µ](#åˆ†å·¥æƒ…å†µ)
  - [è¯¦ç»†è®¾è®¡è¯´æ˜](#è¯¦ç»†è®¾è®¡è¯´æ˜)
    - [Task1](#task1)
    - [Task2](#task2)
    - [Task3\_part1](#task3_part1)
        - [Mapperè®¾è®¡](#mapperè®¾è®¡)
        - [Reducerè®¾è®¡](#reducerè®¾è®¡)
        - [Partitionerè®¾è®¡](#partitionerè®¾è®¡)
        - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾)
    - [Task3\_part2](#task3_part2)
      - [Mapperè®¾è®¡](#mapperè®¾è®¡-1)
      - [Reducerè®¾è®¡](#reducerè®¾è®¡-1)
      - [Partitionerè®¾è®¡](#partitionerè®¾è®¡-1)
      - [è¾“å‡ºç»“æœæˆªå›¾](#è¾“å‡ºç»“æœæˆªå›¾-1)

## å°ç»„ä¿¡æ¯&åˆ†å·¥æƒ…å†µ
é¡¹ç›®åœ°å€ï¼šhttps://github.com/Jaderest/LogAnalysis
### å°ç»„ä¿¡æ¯
- TODO ï¼ˆåˆ«ç›’æˆ‘ğŸ˜­ğŸ˜­ğŸ˜­ï¼‰


### åˆ†å·¥æƒ…å†µ
- TODO


## è¯¦ç»†è®¾è®¡è¯´æ˜
- æœ¬å®éªŒå››ä¸ªä»»åŠ¡å‡é‡‡ç”¨MapReduceæ¡†æ¶å®ç°ï¼Œç¯å¢ƒå¦‚ä¸‹
```
hadoop version: 3.2.1
openjdk version "1.8.0_452"
Apache Maven 3.6.3
```
- åŸºæœ¬æ¡†æ¶ä¸º
  - Mapper
  - Partitionerï¼ˆæ ¹æ®keyå°†Mapperåˆ†å‡ºçš„å†…å®¹ä¼ ç»™ä¸åŒçš„Reducerï¼Œç”±æ­¤æé«˜ä»£ç çš„å¯æ‰©å±•æ€§ï¼Œåœ¨æ›´å¤§çš„é›†ç¾¤ä¸Šä¹Ÿå…·æœ‰åŒæ ·çš„æ‰©å±•æ€§ï¼‰
  - Combinerï¼ˆå¯é€‰ï¼Œé€šå¸¸ç”¨äºå¯¹Mapperçš„è¾“å‡ºè¿›è¡Œå±€éƒ¨èšåˆï¼Œå‡å°‘ä¼ è¾“æ•°æ®é‡ï¼Œæ­¤å¤„ä»…ç”¨äºK-meansèšç±»ç®—æ³•ä¸­ï¼‰
  - Reducer
  - Driverï¼ˆè´Ÿè´£å°†Mapperå’ŒReducerè¿æ¥èµ·æ¥ï¼Œè®¾ç½®è¾“å…¥è¾“å‡ºè·¯å¾„ç­‰ï¼‰


### Task1



### Task2


### Task3_part1
åˆ†æä¼ è¾“æ•°æ®é‡ä¸çŠ¶æ€ç çš„å…³ç³»ï¼šæ ¹æ®body_bytes_sentå­—æ®µå’Œstatuså­—æ®µï¼Œåˆ†æè¯·æ±‚å¤±è´¥ä¸å¤§æ–‡ä»¶ä¼ è¾“æ˜¯å¦ç›¸å…³ã€‚

è®¾è®¡æ€è·¯ï¼šæ ¹æ®çŠ¶æ€ç è¿›è¡ŒåŒºåˆ†ï¼Œç»Ÿè®¡æ¯ä¸ªçŠ¶æ€ç å¯¹åº”çš„body_bytes_sentå­—æ®µçš„å¹³å‡å€¼ï¼Œåˆ†æä¼ è¾“æ•°æ®é‡ä¸çŠ¶æ€ç çš„å…³ç³»ã€‚ä½¿ç”¨`ä¸¤ä¸ªReducer`å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªReducerå¤„ç†çŠ¶æ€ç ä¸º2xxçš„è¯·æ±‚ï¼ˆæˆåŠŸè¯·æ±‚ï¼‰ï¼Œå¦ä¸€ä¸ªReducerå¤„ç†çŠ¶æ€ç ä¸º4xxå’Œ5xxçš„è¯·æ±‚ï¼ˆå¤±è´¥è¯·æ±‚ï¼‰ã€‚

##### Mapperè®¾è®¡
- LogMapperç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`(LongWritable, Text)`ï¼Œå…¶ä¸­LongWritableä¸ºè¡Œå·ï¼ŒTextä¸ºåŸå§‹æ—¥å¿—è¡Œå†…å®¹
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`(Text, FloatWritable)`ï¼Œå…¶ä¸­Textä¸ºçŠ¶æ€ç ï¼ŒFloatWritableä¸ºbody_bytes_sentå­—æ®µçš„å€¼
- åŸå§‹ä»£ç å¦‚ä¸‹
```java
Matcher matcher = logPattern.matcher(value.toString());
if (matcher.find()) {
    String status = matcher.group(6); // é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è·å–çŠ¶æ€ç 
    String bodyBytesSent = matcher.group(7); // è·å–body_bytes_sentå­—æ®µ
    float dataSent = Float.parseFloat(bodyBytesSent);
    context.write(new Text(status), new FloatWritable(dataSent));
}
```

##### Reducerè®¾è®¡
- LogReducerç±»
  - è¾“å…¥é”®å€¼å¯¹ï¼š`<Text, Iterable<FloatWritable>>`ï¼Œå…¶ä¸­Textä¸ºçŠ¶æ€ç ï¼ŒIterable<FloatWritable>ä¸ºæ‰€æœ‰ç›¸åŒçŠ¶æ€ç çš„body_bytes_sentå€¼
  - è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, FloatWritable>`ï¼Œå…¶ä¸­Textä¸ºçŠ¶æ€ç ï¼ŒFloatWritableä¸ºbody_bytes_sentçš„å¹³å‡å€¼
- ä»£ç å¦‚ä¸‹
```java
float sum = 0;
int count = 0;
for (FloatWritable value : values) { // ç»Ÿè®¡åŒä¸€çŠ¶æ€ç çš„æ‰€æœ‰å‘é€æ•°é‡
    sum += value.get();
    count++;
}
float average = sum / count;
context.write(key, new FloatWritable(average));
```

##### Partitionerè®¾è®¡
- æ ¹æ®çŠ¶æ€ç è¿›è¡Œåˆ†ç»„
- ä»£ç å¦‚ä¸‹
```java
if (status.equals("200") || status.equals("201") || status.equals("202") || status.equals("204")) {
    return 0;
} else {
    return 1;
}
```

##### è¾“å‡ºç»“æœæˆªå›¾
- è¾“å‡ºç»“æœä¸ºä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”çŠ¶æ€ç ä¸º2xxå’Œ4xx/5xxçš„è¯·æ±‚
- æˆåŠŸè¯·æ±‚ï¼ˆ2xxï¼‰è¾“å‡ºç¤ºä¾‹ï¼š
![alt text](image.png)
- å¤±è´¥è¯·æ±‚ï¼ˆ4xx/5xxï¼‰è¾“å‡ºç¤ºä¾‹ï¼š
![alt text](image-1.png)
- åˆ†æå¦‚ä¸‹ï¼š
  - è¯·æ±‚æˆåŠŸå¤±è´¥ä¸å¦å’Œä¼ è¾“æ•°æ®é‡å¹¶æ— å¤ªå¤§å…³ç³»
  - åªæœ‰ä¸€ä¸ª499çŠ¶æ€ç æ¯”è¾ƒå¯ç–‘ï¼Œ499çŠ¶æ€ç é€šå¸¸å‡ºç°åœ¨ Nginx æœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œè¡¨ç¤º å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­äº†è¯·æ±‚è¿æ¥
    - åŒæ—¶å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®é‡è¾ƒå¤§ï¼Œå¯èƒ½æ˜¯å› ä¸ºå®¢æˆ·ç«¯åœ¨ä¼ è¾“å¤§æ–‡ä»¶æ—¶è¶…æ—¶ï¼Œæˆ–æ˜¯æœåŠ¡å™¨ç”Ÿæˆå¤§å“åº”ï¼ˆå¦‚å¤æ‚æŸ¥è¯¢ã€æ–‡ä»¶ä¸‹è½½ï¼‰è€—æ—¶è¿‡é•¿ï¼Œå¯¼è‡´ç”¨æˆ·å¤±å»è€å¿ƒ

### Task3_part2
æœ¬ä»»åŠ¡ä»¥å°æ—¶ä¸ºç²’åº¦ç»Ÿè®¡é”™è¯¯è¯·æ±‚å æ¯”ï¼ˆå³é”™è¯¯ç‡ï¼‰ï¼Œé€šè¿‡æ’åºåˆ†æä¸åŒæ—¶é—´æ®µå†…çš„é”™è¯¯ç‡æ³¢åŠ¨æƒ…å†µ


#### Mapperè®¾è®¡
- è¾“å…¥é”®å€¼å¯¹ï¼š`<LongWritable, Text>`
- è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, IntWritable>` Textè¡¨ç¤ºæ—¶é—´æ®µï¼ŒIntWritableè¡¨ç¤ºæ˜¯å¦é”™è¯¯ï¼Œä¸æ˜¯é”™è¯¯åˆ™ä¸º0ï¼Œæ˜¯é”™è¯¯åˆ™ä¸º1
- ä»£ç å¦‚ä¸‹
```java
String status = matcher.group(6); // è¯·æ±‚çŠ¶æ€ç 
String timeLocal = matcher.group(4); // è·å–è®¿é—®æ—¶é—´
// å°†è®¿é—®æ—¶é—´è½¬æ¢ä¸ºå°æ—¶
Date date = sdf.parse(timeLocal);
String hour = new SimpleDateFormat("HH").format(date);

// å¦‚æœè¯·æ±‚çŠ¶æ€æ˜¯å¤±è´¥ï¼ˆé200ç³»åˆ—ï¼‰ï¼Œåˆ™è®¤ä¸ºæ˜¯é”™è¯¯
int isError = (status.startsWith("2")) ? 0 : 1;

// è¾“å‡ºæ—¶é—´æ®µï¼ˆå°æ—¶ï¼‰å’Œé”™è¯¯è®¡æ•°
context.write(new Text(hour), new IntWritable(isError));
```

#### Reducerè®¾è®¡
- å¯¹ç›¸åŒå°æ—¶æ‰€æœ‰è®°å½•è¿›è¡Œèšåˆ
- è¾“å…¥é”®å€¼å¯¹ï¼š`Text, [IntWritable(isError)...]>`ï¼Œå…¶ä¸­Textä¸ºå°æ—¶ï¼ŒIntWritableä¸ºæ˜¯å¦ä¸ºé”™è¯¯
- è¾“å‡ºé”®å€¼å¯¹ï¼š`<Text, FloatWritable>`ï¼Œè¾“å‡ºå°æ—¶å’Œå¹³å‡é”™è¯¯ç‡
```java
int totalRequests = 0;
int failedRequests = 0;

for (IntWritable value : values) {
    totalRequests++;
    if (value.get() == 1) {
        failedRequests++;
    }
}

float errorRate = totalRequests > 0 ? (float) failedRequests / totalRequests : 0.0f;
context.write(key, new FloatWritable(errorRate));
```

#### Partitionerè®¾è®¡
LogPartitioner å°†å°æ—¶åˆ’åˆ†ä¸ºç™½å¤©ï¼ˆ08~22ï¼‰ä¸å¤œé—´ï¼ˆ00~07å’Œ23ï¼‰ä¸¤ç±»ï¼Œåˆ†åˆ«äº¤ç”±ä¸¤ä¸ªReducerå¤„ç†ï¼Œä»¥ä¾¿è§‚å¯Ÿæ˜¼å¤œä¹‹é—´é”™è¯¯ç‡çš„å·®å¼‚ã€‚
```java
int hour = Integer.parseInt(key.toString());
// å°†å°æ—¶åˆ†ä¸ºä¸¤ç»„ï¼š8-22ç‚¹ å’Œ 0-7ç‚¹ã€23ç‚¹
if (hour >= 8 && hour <= 22) {
    return 0; // ç™½å¤©æ—¶é—´æ®µ
} else {
    return 1; // å¤œé—´æ—¶é—´æ®µ
}
```

#### è¾“å‡ºç»“æœæˆªå›¾
![alt text](image-2.png)
![alt text](image-3.png)
